<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      safari.application.addEventListener("message", messageHandler, false);
      safari.application.addEventListener("validate", validateHandler, false);
      safari.application.addEventListener("navigate", navigateHandler, true);

      var globalFeeds = {};
      var feedTitles = {};
      var currentTabUrl;
      google.load("feeds", "1");

      function messageHandler(event) {
        if (event.name === "extractedFeeds") {
          var feeds = event.message;
          globalFeeds[feeds["site"]] = feeds["list"];
          fetchTitlesForFeeds(feeds["list"]);
        }
      }

      function updateItem(url) {
        var menuItem = safari.extension.toolbarItems[0];
        currentTabUrl = url;

        if (url in globalFeeds) {
          var feedCount = globalFeeds[url].length;

          if (feedCount > 0) {
            menuItem.disabled = false;
            menuItem.badge = feedCount;
          } else {
            menuItem.disabled = true;
            menuItem.badge = 0;
          }
        } else {
          menuItem.disabled = true;
          menuItem.badge = 0;
        }
      }

      function navigateHandler(event) {
        var url = event.target.url;

        if (event.type === "navigate") {
          updateItem(url);
        }
      }

      function validateHandler(event) {
        if (event.target.identifier == "menuButton") {
          var menuItem = event.target;
          var url = event.target.browserWindow.activeTab.url;
          updateItem(url);
          purge();
        }
      }

      function isOpenInBrowser(url) {
        var windows = safari.application.browserWindows;

        for (var i = 0; i < windows.length; i++) {
          var tabs = windows[i].tabs;
          for (i = 0; i < tabs.length; i++) {
            if (tabs[i].url === url) {
              return true;
            }
          }
        }

        return false;
      }

      function currentTabFeeds() {
        var feeds = globalFeeds[currentTabUrl];
        var titledFeeds = [];

        for (var i = 0; i < feeds.length; i++) {
          var feed = feeds[i];
          var fetchedTitle = feedTitles[feed["url"]];

          if (fetchedTitle !== undefined) {
            feed["title"] = fetchedTitle;
          }

          titledFeeds.push(feed)
        };

        return titledFeeds;
      }

      function purge() {
        setTimeout(function() {
          for (var url in globalFeeds) {
            if (isOpenInBrowser(url) === false) {
              delete globalFeeds[url];
            }
          }
        }, 500);
      }

      function fetchTitlesForFeeds(feeds) {
        for (var i = 0; i < feeds.length; i++) {
          var feed = feeds[i];
          if (feedTitles[feed["url"]]) return;

          var googleFeed = new google.feeds.Feed(feed["url"]);
          googleFeed.setNumEntries(2);

          googleFeed.load(function(result) {
            if (!result.error) {
              feedTitles[result.feed.feedUrl] = result.feed.title;
            }
          });
        }
      }
    </script>
  </head>
  <body></body>
</html>
